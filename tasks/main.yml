---
# tasks file for ansible-install-mpd

- name: Make group for Music Player Daemon user
  group:
    name: "{{ ansible_install_mpd_user }}"
    state: present
  tags:
    - ansible-install-mpd
    - users

- name: Make user for Music Player Daemon
  user:
    name: "{{ ansible_install_mpd_user }}"
    group: "{{ ansible_install_mpd_group }}"
    home: "{{ ansible_install_mpd_home }}"
    comment: "Music Player Daemon"
  tags:
    - ansible-install-mpd
    - users

- name: Create source base directory
  file:
    path: "{{ ansible_install_mpd_src_base }}"
    owner: "{{ ansible_install_mpd_user }}"
    group: "{{ ansible_install_mpd_group }}"
    state: directory
    mode: 0755
  tags:
    - ansible-install-mpd
    - files

- name: Download and extract tar package
  unarchive:
    remote_src: yes
    dest: "{{ ansible_install_mpd_src_base }}"
    owner: "{{ ansible_install_mpd_user }}"
    group: "{{ ansible_install_mpd_group }}"
    src: "{{ ansible_install_mpd_url_base }}/{{ ansible_install_mpd_filename }}"
    creates: "{{ ansible_install_mpd_src }}"
  tags:
    - ansible-install-mpd
    - files

- name: Add ubuntu-toolchain-r/test PPA
  apt_repository:
    repo: 'ppa:ubuntu-toolchain-r/test'
    update_cache: yes
  tags:
    - ansible-install-mpd
    - packages

- name: Install pre-requisites
  apt:
    name: "{{ item }}"
    cache_valid_time: 3600
    state: latest
  with_items:
    - "{{ ansible_install_mpd_apt_prereqs }}"
  tags:
    - ansible-install-mpd
    - packages

- name: Create softlink for gcc-4.9
  file:
    path: /usr/bin/gcc
    src: /usr/bin/gcc-4.9
    state: link
  tags:
    - ansible-install-mpd
    - files

- name: Create softlink for g++-4.9
  file:
    path: /usr/bin/g++
    src: /usr/bin/g++-4.9
    state: link
  tags:
    - ansible-install-mpd
    - files

- name: Configure source before make
  command: "{{ ansible_install_mpd_src }}/configure -q --enable-httpd-output --enable-shout --enable-vorbis"
  args:
    chdir: "{{ ansible_install_mpd_src }}"
    creates: "{{ ansible_install_mpd_src }}/Makefile"
  become_user: mpd
  tags:
    - ansible-install-mpd
    - files

- name: See if executable already exists
  stat:
    get_checksum: False
    get_md5: False
    path: "{{ ansible_install_mpd_src }}/src/mpd"
  register: stat_output_exec
  tags:
    - ansible-install-mpd
    - files

- name: If not, use make to compile the source
  make:
    chdir: "{{ ansible_install_mpd_src }}"
    params:
      std: c++14
  become_user: mpd
  when: not stat_output_exec.stat.exists
  tags:
    - ansible-install-mpd
    - files

- name: See if executable is already installed
  stat:
    get_checksum: False
    get_md5: False
    path: /usr/local/bin/mpd
  register: stat_output_install
  tags:
    - ansible-install-mpd
    - files

- name: If not, use make to install the compiled source
  make:
    chdir: "{{ ansible_install_mpd_src }}"
    target: install
  when: not stat_output_install.stat.exists
  tags:
    - ansible-install-mpd
    - files
